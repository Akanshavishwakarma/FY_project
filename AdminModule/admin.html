<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="../AdminModule/css/admin.css" />
  </head>

  <body>
    <div id="blur">
      <header>
        <h2>Admin Control Panel</h2>
        <div class="actions">
          <button onclick="openCustomer()">+ Customer</button>
          <button onclick="openUser()">+ User</button>
        </div>
      </header>

      <!-- CUSTOMER LIST BUTTON -->
      <div class="customer-list-bar">
        <button onclick="toggleCustomerList()">Customer List</button>
      </div>

      <!-- CUSTOMER LIST -->
      <div
        class="employee-section"
        id="customerListSection"
        style="display: none"
      >
        <h3>Customer List</h3>
        <table>
          <thead>
            <tr>
              <th></th>
              <th>Sr No</th>
              <th>Customer Name</th>
              <th>Customer ID</th>
              <th>Password</th>
            </tr>
          </thead>
          <tbody id="customerListBody"></tbody>
        </table>
      </div>

      <!-- EMPLOYEE LIST -->
      <section class="employee-section">
        <h3>Employee List</h3>
        <table>
          <thead>
            <tr>
              <th></th>
              <th>Sr No</th>
              <th>Employee Name</th>
              <th>Password</th>
              <th>Status</th>
            </tr>
          </thead>

          <tbody id="employeeList"></tbody>
        </table>
      </section>
    </div>

    <!-- ADD USER -->
    <div class="modal" id="userModal">
      <h3>Add Employee</h3>
      <input type="text" id="empName" placeholder="Employee Name" />
      <input type="text" id="empId" placeholder="Employee ID" />
      <input type="password" id="empPassword" placeholder="Password" />
      <button onclick="addEmployee()">Done</button>
      <button class="cancel" onclick="closeModals()">Cancel</button>
    </div>

    <!-- ADD CUSTOMER -->
    <div class="modal" id="customerModal">
      <h3>Add Customer</h3>
      <input type="text" id="custName" placeholder="Customer Name" />
      <input type="text" id="custId" placeholder="Customer ID" />
      <input type="password" id="custPassword" placeholder="Password" />
      <button onclick="addCustomer()">Add Customer</button>
      <button class="cancel" onclick="closeModals()">Cancel</button>
    </div>

    <!-- ASSIGN -->
    <div class="modal" id="assignModal">
      <h3 id="assignTitle">Assign Customers</h3>
      <div id="customerCheckboxes"></div>

      <button onclick="assignCustomer()">Assign</button>
      <button onclick="notAssignCustomer()" class="danger">Not Assign</button>
      <button class="cancel" onclick="closeModals()">Cancel</button>
    </div>

    <!-- DELETE CONFIRM -->
    <div class="modal" id="deleteModal">
      <h3 id="deleteText"></h3>
      <button onclick="confirmDelete()">Confirm</button>
      <button class="cancel" onclick="closeModals()">Cancel</button>
    </div>

    <!--javascript -->

    <script>
      let deleteType = "";
      let deleteId = "";

      const API = "http://localhost:3000";

      /* ================= BLUR ================= */
      function blurOn() {
        document.getElementById("blur").classList.add("blur");
      }
      function blurOff() {
        document.getElementById("blur").classList.remove("blur");
      }
      function closeModals() {
        blurOff();
        document
          .querySelectorAll(".modal")
          .forEach((m) => m.classList.remove("show"));
      }
      function clearInputs() {
        document
          .querySelectorAll(".modal input")
          .forEach((i) => (i.value = ""));
      }

      /* ================= OPEN MODALS ================= */
      function openUser() {
        clearInputs();
        blurOn();
        userModal.classList.add("show");
      }
      function openCustomer() {
        clearInputs();
        blurOn();
        customerModal.classList.add("show");
      }

      /* ================= LOAD DATA ================= */
      window.onload = () => {
        loadEmployees();
        loadCustomers();
      };

      function loadEmployees() {
        fetch(API + "/employees")
          .then((res) => res.json())
          .then((data) => {
            employeeList.innerHTML = "";
            data.forEach((e, i) => {
              employeeList.innerHTML += `
<tr>
  <td>
    <div class="delete-box"
      onclick="openDelete('employee','${e.emp_id}')">✖</div>
  </td>
  <td>${i + 1}</td>
  <td onclick="openAssign('${e.emp_id}', '${e.assigned_customers || ""}')">
    ${e.emp_name}
    <div class="assigned-customers">${e.assigned_customers || ""}</div>
  </td>
 <td>${e.password}</td>
  <td class="${e.assigned_customers ? "assigned" : "not"}">
    ${e.assigned_customers ? "Assigned" : "Not Assigned"}
  </td>
</tr>`;
            });
          });
      }
      function loadCustomers() {
        fetch(API + "/customers")
          .then((res) => res.json())
          .then((data) => {
            customerListBody.innerHTML = "";
            data.forEach((c, i) => {
              customerListBody.innerHTML += `
<tr>
  <td>
    <div class="delete-box small"
      onclick="openDelete('customer','${c.cust_id}')">✖</div>
  </td>
  <td>${i + 1}</td>
  <td>${c.cust_name}</td>
  <td>${c.cust_id}</td>
<td>${c.password}</td>
</tr>`;
            });
          });
      }

      /* ================= ADD EMPLOYEE ================= */
      function addEmployee() {
        if (!empName.value || !empId.value || !empPassword.value) {
          alert("Fill all fields");
          return;
        }

        fetch(API + "/employees", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            name: empName.value,
            empId: empId.value,
            password: empPassword.value,
          }),
        })
          .then((res) => res.text())
          .then((msg) => {
            alert(msg);
            closeModals();
            loadCustomers();
          });
      }

      /* ================= ADD CUSTOMER ================= */
      function addCustomer() {
        if (!custName.value || !custId.value || !custPassword.value) {
          alert("Fill all fields");
          return;
        }

        fetch(API + "/customers", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            name: custName.value,
            custId: custId.value,
            password: custPassword.value,
          }),
        })
          .then((res) => res.text())
          .then((msg) => {
            alert(msg);
            closeModals();
            loadCustomers();
          });
      }

      /* ================= ASSIGN ================= */
      let currentEmpId = "";

      function openAssign(empId, assignedCustomers) {
        currentEmpId = empId;
        blurOn();
        assignModal.classList.add("show");
        customerCheckboxes.innerHTML = "";

        // string → array
        let assigned = [];
        if (assignedCustomers) {
          assigned = assignedCustomers.split(",").map((c) => c.trim());
        }

        fetch(API + "/customers")
          .then((res) => res.json())
          .then((data) => {
            data.forEach((c) => {
              const checked = assigned.includes(c.cust_name);

              customerCheckboxes.innerHTML += `
          <div class="customer-row">
            <input type="checkbox" value="${c.cust_name}" ${
                checked ? "checked" : ""
              }>
            <span>${c.cust_name} (${c.cust_id})</span>
          </div>
        `;
            });
          });
      }

      function assignCustomer() {
        const selected = [
          ...document.querySelectorAll("#customerCheckboxes input:checked"),
        ].map((i) => i.value);

        fetch(API + "/assign", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            empId: currentEmpId,
            customers: selected,
          }),
        }).then(() => {
          closeModals();
          loadEmployees();
        });
      }

      /*==========Not assign=============*/

      function notAssignCustomer() {
        if (!currentEmpId) return;

        if (!confirm("Remove all assigned customers from this employee?"))
          return;

        fetch(API + "/unassign/" + currentEmpId, {
          method: "PUT",
        })
          .then((res) => res.text())
          .then((msg) => {
            alert(msg);
            closeModals();
            loadEmployees();
          });
      }

      /* ================= CUSTOMER LIST TOGGLE ================= */
      function toggleCustomerList() {
        const section = document.getElementById("customerListSection");
        section.style.display =
          section.style.display === "none" ? "block" : "none";
      }

      function openDelete(type, id) {
        deleteType = type;
        deleteId = id;
        blurOn();
        deleteText.innerText = `Do you want to remove this ${type}?`;
        deleteModal.classList.add("show");
      }

      function confirmDelete() {
        fetch(`${API}/${deleteType}s/${deleteId}`, {
          method: "DELETE",
        })
          .then((res) => res.text())
          .then((msg) => {
            alert(msg);
            closeModals();
            loadEmployees();
            loadCustomers();
          });
      }
    </script>
  </body>
</html>
